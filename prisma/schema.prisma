// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String            @id @default(cuid())
  email        String            @unique
  passwordHash String?
  role         String            @default("CLIENT") // ADMIN, CLIENT, COMPTABLE, MAGASINIER, COMMERCIAL
  userType     String?           // 'MAGASINIER' ou 'LIVREUR' pour distinguer les sous-types du rôle MAGASINIER
  name         String
  clientCode   String?           @unique // Référence client (ex: CLI-001) pour recherche et documents
  companyName  String?
  segment      String            @default("LABO") // LABO, DENTISTE, REVENDEUR
  discountRate Float? // Remise client en pourcentage (ex: 5 = -5%)
  balance      Float             @default(0.0)
  creditLimit  Float             @default(0) // Plafond de crédit (0 = pas de crédit autorisé)
  phone        String? // Téléphone client
  address      String? // Adresse client
  city         String? // Ville client
  ice          String? // ICE client (Identifiant Commun de l'Entreprise)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  orders              Order[]
  favorites           FavoriteProduct[]
  requests            ClientRequest[]
  passwordResetTokens PasswordResetToken[]
}

model Invitation {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([userId])
}

model Product {
  id             String            @id @default(cuid())
  sku            String?           @unique // Référence / SKU produit (ex: PROD-001) pour catalogue et stock
  name           String
  description    String?
  price          Float // Legacy field, kept for backward compatibility (treated as LABO price)
  priceLabo      Float?
  priceDentiste  Float?
  priceRevendeur Float?
  cost           Float             @default(0) // Coût d'achat du produit
  stock          Int               @default(0)
  minStock       Int               @default(5)
  category       String?
  imageUrl       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  orderItems     OrderItem[]
  stockMovements StockMovement[]
  segmentPrices  ProductPrice[]
  favorites      FavoriteProduct[]
  variants       ProductVariant[]  // Variantes vendables (SKU, stock, prix par variante)
  options        ProductOption[]   // Optionnel : options de variantes (Teinte, Taille, etc.)
}

model ProductVariant {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku             String   @unique // SKU unique (global avec Product.sku)
  name            String?  // Suffixe affiché (ex. "Teinte A2", "Taille 12")
  stock           Int      @default(0)
  minStock        Int      @default(5)
  priceLabo       Float?
  priceDentiste   Float?
  priceRevendeur  Float?
  cost            Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  orderItems      OrderItem[]
  stockMovements  StockMovement[]
  favorites       FavoriteProduct[]
  optionValues    ProductVariantOptionValue[] // Optionnel : lien vers les valeurs d'options

  @@index([productId])
}

// Optionnel : décrire les options de variantes (ex. Teinte, Taille) et leurs valeurs
model ProductOption {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String   // ex. "Variété", "Teinte", "Dimension"
  order     Int      @default(0) // Ordre d'affichage : 1=Variété, 2=Teinte, 3=Dimension
  values    ProductOptionValue[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

model ProductOptionValue {
  id         String   @id @default(cuid())
  optionId   String
  option     ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  value      String   // ex. "A2", "12"
  variantLinks ProductVariantOptionValue[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([optionId, value])
  @@index([optionId])
}

model ProductVariantOptionValue {
  id             String           @id @default(cuid())
  variantId      String
  variant        ProductVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  optionValueId  String
  optionValue    ProductOptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())

  @@unique([variantId, optionValueId])
  @@index([variantId])
  @@index([optionValueId])
}

model ProductPrice {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  segment   String // LABO, DENTISTE, REVENDEUR
  price     Float
  createdAt DateTime @default(now())

  @@unique([productId, segment])
}

model StockMovement {
  id               String         @id @default(cuid())
  productId        String
  product          Product        @relation(fields: [productId], references: [id])
  productVariantId String?        // Si set, le mouvement s'applique au stock de la variante
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  type             String // IN, OUT, RESERVED, ADJUSTMENT
  quantity         Int
  reference        String?
  createdAt        DateTime       @default(now())
  createdBy        String?

  @@index([productVariantId])
}

model Order {
  id                       String        @id @default(cuid())
  userId                   String
  user                     User          @relation(fields: [userId], references: [id])
  orderNumber              String?       @unique
  deliveryNoteNumber       String?       @unique // Format: BL-YYYYMMDD-0001 (généré automatiquement lors du passage à PREPARED)
  status                   String        @default("CONFIRMED") // CONFIRMED, PREPARED, SHIPPED, DELIVERED, CANCELLED
  total                    Float
  requiresAdminApproval    Boolean       @default(false) // true si au moins une ligne a priceAtTime < costAtTime
  deliveryCity             String?
  deliveryAddress          String?
  deliveryPhone            String?
  deliveryNote             String?
  shippedAt                DateTime?
  deliveredAt              DateTime?
  deliveryAgentName        String? // commercial/livreur (legacy, kept for backward compatibility)
  deliveryAgentId          String? // ID du livreur assigné (plus fiable que le nom)
  deliveredToName          String?
  deliveryProofNote        String?
  deliveryConfirmationCode String? // Code de confirmation unique pour la livraison (généré lors de l'expédition)
  updatedBy                String? // G3: Qui a modifié la commande (userId)
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  items                    OrderItem[]
  invoice                  Invoice?
  deliveryNoteDoc          DeliveryNote? @relation("OrderDeliveryNote")
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  order            Order          @relation(fields: [orderId], references: [id])
  productId        String
  product          Product        @relation(fields: [productId], references: [id])
  productVariantId String?        // Si set, la ligne commande cette variante (prix/stock variante)
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  quantity         Int
  priceAtTime      Float // Prix unitaire au moment de la commande (après remise si applicable)
  costAtTime       Float   @default(0) // Coût unitaire au moment de la commande

  @@index([productVariantId])
}

model DeliveryNote {
  id        String   @id @default(cuid())
  number    String   @unique
  orderId   String   @unique
  order     Order    @relation("OrderDeliveryNote", fields: [orderId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String    @id @default(cuid())
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id])
  invoiceNumber String?   @unique
  status        String    @default("UNPAID") // UNPAID, PARTIAL, PAID, CANCELLED
  amount        Float
  balance       Float // Amount remaining to be paid
  paidBy        String? // G3: Qui a marqué la facture comme payée (userId)
  createdAt     DateTime  @default(now())
  paidAt        DateTime?
  payments      Payment[]
}

model GlobalSequence {
  id        String   @id @default(cuid())
  key       String   @unique // Format: ORDER-2025, INVOICE-2025, DELIVERY-2025
  seq       Int      @default(0)
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String   @id @default(cuid())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  amount    Float
  method    String // CASH, CHECK, TRANSFER, COD
  reference String?
  createdBy String? // G3: Qui a créé le paiement (userId)
  createdAt DateTime @default(now())
}

model AdminSettings {
  id                                        String   @id @default("default")
  requireApprovalIfAnyNegativeLineMargin    Boolean  @default(true)
  requireApprovalIfMarginBelowPercent       Boolean  @default(false)
  marginPercentThreshold                    Float    @default(0) // ex 5 = 5%
  requireApprovalIfOrderTotalMarginNegative Boolean  @default(false)
  blockWorkflowUntilApproved                Boolean  @default(true)
  approvalMessage                           String   @default("Commande à valider (marge anormale)")
  companyName                               String? // Nom de l'entreprise
  companyICE                                String? // ICE (Identifiant Commun de l'Entreprise)
  companyAddress                            String? // Adresse de l'entreprise
  companyPhone                              String? // Téléphone de l'entreprise
  updatedAt                                 DateTime @updatedAt
}

model CompanySettings {
  id                 String   @id @default("default")
  name               String // Raison sociale (obligatoire)
  address            String // Adresse (obligatoire)
  city               String // Ville (obligatoire)
  country            String // Pays (obligatoire)
  ice                String // ICE (obligatoire)
  if                 String? // IF (facultatif)
  rc                 String? // RC (facultatif)
  tp                 String? // TP (facultatif)
  phone              String? // Téléphone (facultatif)
  email              String? // Email (facultatif)
  vatRate            Float    @default(0.2) // Taux TVA par défaut 20%
  paymentTerms       String?  // Conditions de paiement (facultatif)
  vatMention         String? // Mention TVA (ex: "TVA incluse selon le taux en vigueur")
  latePaymentMention String? // Mention retard de paiement (ex: "Tout retard de paiement peut entraîner des pénalités")
  logoUrl            String? // URL du logo de l'entreprise
  bankName           String? // Nom de la banque (affiché sur les factures)
  rib                String? // RIB / Relevé d'identité bancaire (affiché sur les factures)
  updatedAt          DateTime @updatedAt
}

model FavoriteProduct {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId        String
  product          Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariantId String?        // Si set, favori sur cette variante précise
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  createdAt        DateTime       @default(now())

  @@unique([userId, productId, productVariantId]) // Un favori par (user, produit, variante) — productVariantId null = produit simple
  @@index([userId])
  @@index([productId])
  @@index([productVariantId])
}

model ClientRequest {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       String // "PRODUCT_REQUEST" | "ADVICE" | "CONTACT" | "REMARK"
  message    String // Texte limité (500 caractères max)
  status     String    @default("PENDING") // "PENDING" | "READ" | "RESOLVED"
  adminNotes String? // Notes internes admin
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  readAt     DateTime? // Quand l'admin a lu
  resolvedAt DateTime? // Quand résolu

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String // Type d'action: ORDER_CREATED, ORDER_UPDATED, ORDER_STATUS_CHANGED, INVOICE_CREATED, PAYMENT_RECORDED, PRODUCT_CREATED, PRODUCT_UPDATED, CLIENT_CREATED, CLIENT_UPDATED, LOGIN, LOGOUT, etc.
  entityType String // Type d'entité: ORDER, INVOICE, PAYMENT, PRODUCT, USER, STOCK, etc.
  entityId   String? // ID de l'entité concernée
  userId     String? // ID de l'utilisateur qui a effectué l'action
  userEmail  String? // Email de l'utilisateur (pour référence rapide)
  userRole   String? // Rôle de l'utilisateur (ADMIN, CLIENT, etc.)
  details    String? // Détails JSON de l'action (anciennes/nouvelles valeurs, etc.)
  ipAddress  String? // Adresse IP de l'utilisateur
  userAgent  String? // User agent du navigateur
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}
